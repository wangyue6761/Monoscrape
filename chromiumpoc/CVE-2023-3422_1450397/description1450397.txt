<b>VULNERABILITY DETAILS</b>
UAF in guest_view::GuestViewManager::EmbedderProcessDestroyed when destroy the webview app.

<b>VERSION</b>
Chromium	116.0.5805.0 (Developer Build) (64-bit) 
Revision	7e43ded13451eef1b12f8df95432f93ce9230cc3-refs/heads/main@{#1151488}
OS	Windows 10 Version 22H2 (Build 19045.2965)

<b>REPRODUCTION CASE</b>
1. put background.js/index.html/manifest.json/script.js into the extension_dir
2. put poc.html/testharness.js/urltestdata.json into webserver dir and run the command: python3 -m http.server 8000
3. run the command in the terminal :
chrome.exe --user-data-dir=tmp --load-extension=extension_dir
4. press Ctrl+C in the terminal to trigger the UAF.(Some other way will also trigger the UAF )

I have reproduced this issue in Windows/Linux/ChromiumOS.

<b>FOR CRASHES, PLEASE INCLUDE THE FOLLOWING ADDITIONAL INFORMATION</b>
Type of crash: [browser]


=================================================================
==14048==ERROR: AddressSanitizer: heap-use-after-free on address 0x1173e0150c98 at pc 0x7ffeca7d4d4d bp 0x00535bbfe1c0 sp 0x00535bbfe208
READ of size 8 at 0x1173e0150c98 thread T0
==14048==WARNING: Failed to use and restart external symbolizer!
    #0 0x7ffeca7d4d4c in std::__Cr::__tree_iterator<std::__Cr::__value_type<void *,perfetto::base::UnixTaskRunner::WatchTask>,std::__Cr::__tree_node<std::__Cr::__value_type<void *,perfetto::base::UnixTaskRunner::WatchTask>,void *> *,long long>::operator++ C:\b\s\w\ir\cache\builder\src\buildtools\third_party\libc++\trunk\include\__tree:866
    #1 0x7ffeca7d4e43 in std::__Cr::__tree<std::__Cr::__value_type<std::__Cr::chrono::duration<long long,std::__Cr::ratio<1,1000> >,std::__Cr::function<void ()> >,std::__Cr::__map_value_compare<std::__Cr::chrono::duration<long long,std::__Cr::ratio<1,1000> >,std::__Cr::__value_type<std::__Cr::chrono::duration<long long,std::__Cr::ratio<1,1000> >,std::__Cr::function<void ()> >,std::__Cr::less<std::__Cr::chrono::duration<long long,std::__Cr::ratio<1,1000> > >,1>,std::__Cr::allocator<std::__Cr::__value_type<std::__Cr::chrono::duration<long long,std::__Cr::ratio<1,1000> >,std::__Cr::function<void ()> > > >::__remove_node_pointer C:\b\s\w\ir\cache\builder\src\buildtools\third_party\libc++\trunk\include\__tree:2257
    #2 0x7ffedaa7a6db in std::__Cr::__tree<std::__Cr::__value_type<int,std::__Cr::unique_ptr<guest_view::GuestViewBase,std::__Cr::default_delete<guest_view::GuestViewBase> > >,std::__Cr::__map_value_compare<int,std::__Cr::__value_type<int,std::__Cr::unique_ptr<guest_view::GuestViewBase,std::__Cr::default_delete<guest_view::GuestViewBase> > >,std::__Cr::less<int>,1>,std::__Cr::allocator<std::__Cr::__value_type<int,std::__Cr::unique_ptr<guest_view::GuestViewBase,std::__Cr::default_delete<guest_view::GuestViewBase> > > > >::__erase_multi<int> C:\b\s\w\ir\cache\builder\src\buildtools\third_party\libc++\trunk\include\__tree:2467
    #3 0x7ffedaa75b8f in guest_view::GuestViewManager::EmbedderProcessDestroyed C:\b\s\w\ir\cache\builder\src\components\guest_view\browser\guest_view_manager.cc:356
    #4 0x7ffed33decf5 in content::RenderProcessHostImpl::ProcessDied C:\b\s\w\ir\cache\builder\src\content\browser\renderer_host\render_process_host_impl.cc:5003
    #5 0x7ffed33de25d in content::RenderProcessHostImpl::FastShutdownIfPossible C:\b\s\w\ir\cache\builder\src\content\browser\renderer_host\render_process_host_impl.cc:3834
    #6 0x7ffed80f5b9c in browser_shutdown::OnShutdownStarting C:\b\s\w\ir\cache\builder\src\chrome\browser\lifetime\browser_shutdown.cc:169
    #7 0x7ffedb58971a in chrome::SessionEnding C:\b\s\w\ir\cache\builder\src\chrome\browser\lifetime\application_lifetime_desktop.cc:228
    #8 0x7ffed6a3f352 in base::internal::Invoker<base::internal::BindState<void (*)(unsigned long),unsigned long>,void ()>::RunOnce C:\b\s\w\ir\cache\builder\src\base\functional\bind_internal.h:976
    #9 0x7ffed82d1aa6 in base::TaskAnnotator::RunTaskImpl C:\b\s\w\ir\cache\builder\src\base\task\common\task_annotator.cc:186
    #10 0x7ffedb8f3f82 in base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::DoWorkImpl C:\b\s\w\ir\cache\builder\src\base\task\sequence_manager\thread_controller_with_message_pump_impl.cc:486
    #11 0x7ffedb8f2cff in base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::DoWork C:\b\s\w\ir\cache\builder\src\base\task\sequence_manager\thread_controller_with_message_pump_impl.cc:351
    #12 0x7ffed820ef40 in base::MessagePumpForUI::DoRunLoop C:\b\s\w\ir\cache\builder\src\base\message_loop\message_pump_win.cc:211
    #13 0x7ffed820c9c6 in base::MessagePumpWin::Run C:\b\s\w\ir\cache\builder\src\base\message_loop\message_pump_win.cc:77
    #14 0x7ffedb8f666f in base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::Run C:\b\s\w\ir\cache\builder\src\base\task\sequence_manager\thread_controller_with_message_pump_impl.cc:651
    #15 0x7ffed833c2d7 in base::RunLoop::Run C:\b\s\w\ir\cache\builder\src\base\run_loop.cc:134
    #16 0x7ffed228a48b in content::BrowserMainLoop::RunMainMessageLoop C:\b\s\w\ir\cache\builder\src\content\browser\browser_main_loop.cc:1067
    #17 0x7ffed2291697 in content::BrowserMainRunnerImpl::Run C:\b\s\w\ir\cache\builder\src\content\browser\browser_main_runner_impl.cc:158
    #18 0x7ffed2282102 in content::BrowserMain C:\b\s\w\ir\cache\builder\src\content\browser\browser_main.cc:34
    #19 0x7ffed6a39785 in content::RunBrowserProcessMain C:\b\s\w\ir\cache\builder\src\content\app\content_main_runner_impl.cc:707
    #20 0x7ffed6a3d841 in content::ContentMainRunnerImpl::RunBrowser C:\b\s\w\ir\cache\builder\src\content\app\content_main_runner_impl.cc:1284
    #21 0x7ffed6a3cf8b in content::ContentMainRunnerImpl::Run C:\b\s\w\ir\cache\builder\src\content\app\content_main_runner_impl.cc:1138
    #22 0x7ffed6a3787f in content::RunContentProcess C:\b\s\w\ir\cache\builder\src\content\app\content_main.cc:326
    #23 0x7ffed6a38589 in content::ContentMain C:\b\s\w\ir\cache\builder\src\content\app\content_main.cc:343
    #24 0x7ffeca74171d in ChromeMain C:\b\s\w\ir\cache\builder\src\chrome\app\chrome_main.cc:187
    #25 0x7ff6381563e4 in MainDllLoader::Launch C:\b\s\w\ir\cache\builder\src\chrome\app\main_dll_loader_win.cc:166
    #26 0x7ff638152bd8 in main C:\b\s\w\ir\cache\builder\src\chrome\app\chrome_exe_main_win.cc:390
    #27 0x7ff63858204b in __scrt_common_main_seh D:\a\_work\1\s\src\vctools\crt\vcstartup\src\startup\exe_common.inl:288
    #28 0x7fffa0d37613 in BaseThreadInitThunk+0x13 (C:\Windows\System32\KERNEL32.DLL+0x180017613)
    #29 0x7fffa10026a0 in RtlUserThreadStart+0x20 (C:\Windows\SYSTEM32\ntdll.dll+0x1800526a0)

0x1173e0150c98 is located 8 bytes inside of 48-byte region [0x1173e0150c90,0x1173e0150cc0)
freed by thread T0 here:
    #0 0x7ff63820f23d in free C:\b\s\w\ir\cache\builder\src\third_party\llvm\compiler-rt\lib\asan\asan_malloc_win.cpp:82
    #1 0x7ffedaa73259 in std::__Cr::multimap<int,std::__Cr::unique_ptr<guest_view::GuestViewBase,std::__Cr::default_delete<guest_view::GuestViewBase> >,std::__Cr::less<int>,std::__Cr::allocator<std::__Cr::pair<const int,std::__Cr::unique_ptr<guest_view::GuestViewBase,std::__Cr::default_delete<guest_view::GuestViewBase> > > > >::erase C:\b\s\w\ir\cache\builder\src\buildtools\third_party\libc++\trunk\include\map:2080
    #2 0x7ffedaa730b4 in guest_view::GuestViewManager::TransferOwnership C:\b\s\w\ir\cache\builder\src\components\guest_view\browser\guest_view_manager.cc:193
    #3 0x7ffedaa87408 in guest_view::`anonymous namespace'::DestroyGuestIfUnattached C:\b\s\w\ir\cache\builder\src\components\guest_view\browser\guest_view_base.cc:37
    #4 0x7ffed3859eac in content::WebContentsImpl::WebContentsObserverList::NotifyObservers<void (content::WebContentsObserver::*)()> C:\b\s\w\ir\cache\builder\src\content\browser\web_contents\web_contents_impl.h:1549
    #5 0x7ffed385783f in content::WebContentsImpl::~WebContentsImpl C:\b\s\w\ir\cache\builder\src\content\browser\web_contents\web_contents_impl.cc:1183
    #6 0x7ffed38d5aa5 in content::WebContentsImpl::~WebContentsImpl C:\b\s\w\ir\cache\builder\src\content\browser\web_contents\web_contents_impl.cc:1075
    #7 0x7ffed51f8514 in extensions::WebViewGuest::~WebViewGuest C:\b\s\w\ir\cache\builder\src\extensions\browser\guest_view\web_view\web_view_guest.cc:808
    #8 0x7ffed5200f1d in extensions::WebViewGuest::~WebViewGuest C:\b\s\w\ir\cache\builder\src\extensions\browser\guest_view\web_view\web_view_guest.cc:798
    #9 0x7ffedaa7a6ec in std::__Cr::__tree<std::__Cr::__value_type<int,std::__Cr::unique_ptr<guest_view::GuestViewBase,std::__Cr::default_delete<guest_view::GuestViewBase> > >,std::__Cr::__map_value_compare<int,std::__Cr::__value_type<int,std::__Cr::unique_ptr<guest_view::GuestViewBase,std::__Cr::default_delete<guest_view::GuestViewBase> > >,std::__Cr::less<int>,1>,std::__Cr::allocator<std::__Cr::__value_type<int,std::__Cr::unique_ptr<guest_view::GuestViewBase,std::__Cr::default_delete<guest_view::GuestViewBase> > > > >::__erase_multi<int> C:\b\s\w\ir\cache\builder\src\buildtools\third_party\libc++\trunk\include\__tree:2467
    #10 0x7ffedaa75b8f in guest_view::GuestViewManager::EmbedderProcessDestroyed C:\b\s\w\ir\cache\builder\src\components\guest_view\browser\guest_view_manager.cc:356
    #11 0x7ffed33decf5 in content::RenderProcessHostImpl::ProcessDied C:\b\s\w\ir\cache\builder\src\content\browser\renderer_host\render_process_host_impl.cc:5003
    #12 0x7ffed33de25d in content::RenderProcessHostImpl::FastShutdownIfPossible C:\b\s\w\ir\cache\builder\src\content\browser\renderer_host\render_process_host_impl.cc:3834
    #13 0x7ffed80f5b9c in browser_shutdown::OnShutdownStarting C:\b\s\w\ir\cache\builder\src\chrome\browser\lifetime\browser_shutdown.cc:169
    #14 0x7ffedb58971a in chrome::SessionEnding C:\b\s\w\ir\cache\builder\src\chrome\browser\lifetime\application_lifetime_desktop.cc:228
    #15 0x7ffed6a3f352 in base::internal::Invoker<base::internal::BindState<void (*)(unsigned long),unsigned long>,void ()>::RunOnce C:\b\s\w\ir\cache\builder\src\base\functional\bind_internal.h:976
    #16 0x7ffed82d1aa6 in base::TaskAnnotator::RunTaskImpl C:\b\s\w\ir\cache\builder\src\base\task\common\task_annotator.cc:186
    #17 0x7ffedb8f3f82 in base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::DoWorkImpl C:\b\s\w\ir\cache\builder\src\base\task\sequence_manager\thread_controller_with_message_pump_impl.cc:486
    #18 0x7ffedb8f2cff in base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::DoWork C:\b\s\w\ir\cache\builder\src\base\task\sequence_manager\thread_controller_with_message_pump_impl.cc:351
    #19 0x7ffed820ef40 in base::MessagePumpForUI::DoRunLoop C:\b\s\w\ir\cache\builder\src\base\message_loop\message_pump_win.cc:211
    #20 0x7ffed820c9c6 in base::MessagePumpWin::Run C:\b\s\w\ir\cache\builder\src\base\message_loop\message_pump_win.cc:77
    #21 0x7ffedb8f666f in base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::Run C:\b\s\w\ir\cache\builder\src\base\task\sequence_manager\thread_controller_with_message_pump_impl.cc:651
    #22 0x7ffed833c2d7 in base::RunLoop::Run C:\b\s\w\ir\cache\builder\src\base\run_loop.cc:134
    #23 0x7ffed228a48b in content::BrowserMainLoop::RunMainMessageLoop C:\b\s\w\ir\cache\builder\src\content\browser\browser_main_loop.cc:1067
    #24 0x7ffed2291697 in content::BrowserMainRunnerImpl::Run C:\b\s\w\ir\cache\builder\src\content\browser\browser_main_runner_impl.cc:158
    #25 0x7ffed2282102 in content::BrowserMain C:\b\s\w\ir\cache\builder\src\content\browser\browser_main.cc:34
    #26 0x7ffed6a39785 in content::RunBrowserProcessMain C:\b\s\w\ir\cache\builder\src\content\app\content_main_runner_impl.cc:707
    #27 0x7ffed6a3d841 in content::ContentMainRunnerImpl::RunBrowser C:\b\s\w\ir\cache\builder\src\content\app\content_main_runner_impl.cc:1284

previously allocated by thread T0 here:
    #0 0x7ff63820f33d in malloc C:\b\s\w\ir\cache\builder\src\third_party\llvm\compiler-rt\lib\asan\asan_malloc_win.cpp:98
    #1 0x7ffeedecbfde in operator new D:\a\_work\1\s\src\vctools\crt\vcstartup\src\heap\new_scalar.cpp:35
    #2 0x7ffedaa7944d in std::__Cr::__tree<std::__Cr::__value_type<int,std::__Cr::unique_ptr<guest_view::GuestViewBase,std::__Cr::default_delete<guest_view::GuestViewBase> > >,std::__Cr::__map_value_compare<int,std::__Cr::__value_type<int,std::__Cr::unique_ptr<guest_view::GuestViewBase,std::__Cr::default_delete<guest_view::GuestViewBase> > >,std::__Cr::less<int>,1>,std::__Cr::allocator<std::__Cr::__value_type<int,std::__Cr::unique_ptr<guest_view::GuestViewBase,std::__Cr::default_delete<guest_view::GuestViewBase> > > > >::__emplace_multi<std::__Cr::pair<const int,std::__Cr::unique_ptr<guest_view::GuestViewBase,std::__Cr::default_delete<guest_view::GuestViewBase> > > > C:\b\s\w\ir\cache\builder\src\buildtools\third_party\libc++\trunk\include\__tree:2192
    #3 0x7ffedaa7354f in guest_view::GuestViewManager::ManageOwnership C:\b\s\w\ir\cache\builder\src\components\guest_view\browser\guest_view_manager.cc:210
    #4 0x7ffed51f60f9 in extensions::WebViewGuest::RequestNewWindowPermission C:\b\s\w\ir\cache\builder\src\extensions\browser\guest_view\web_view\web_view_guest.cc:1603
    #5 0x7ffed51ff415 in extensions::WebViewGuest::AddNewContents C:\b\s\w\ir\cache\builder\src\extensions\browser\guest_view\web_view\web_view_guest.cc:1393
    #6 0x7ffed3885ac4 in content::WebContentsImpl::ShowCreatedWindow C:\b\s\w\ir\cache\builder\src\content\browser\web_contents\web_contents_impl.cc:4384
    #7 0x7ffed32cf2b2 in content::RenderFrameHostImpl::ShowCreatedWindow C:\b\s\w\ir\cache\builder\src\content\browser\renderer_host\render_frame_host_impl.cc:5768
    #8 0x7ffecdd17ded in blink::mojom::LocalMainFrameHostStubDispatch::AcceptWithResponder C:\b\s\w\ir\cache\builder\src\out\Release_x64\gen\third_party\blink\public\mojom\frame\frame.mojom.cc:19406
    #9 0x7ffed3347518 in blink::mojom::LocalMainFrameHostStub<mojo::RawPtrImplRefTraits<blink::mojom::LocalMainFrameHost> >::AcceptWithResponder C:\b\s\w\ir\cache\builder\src\out\Release_x64\gen\third_party\blink\public\mojom\frame\frame.mojom.h:1995
    #10 0x7ffed8a3b44f in mojo::InterfaceEndpointClient::HandleValidatedMessage C:\b\s\w\ir\cache\builder\src\mojo\public\cpp\bindings\lib\interface_endpoint_client.cc:970
    #11 0x7ffedbde334f in mojo::MessageDispatcher::Accept C:\b\s\w\ir\cache\builder\src\mojo\public\cpp\bindings\lib\message_dispatcher.cc:48
    #12 0x7ffed8a40f51 in mojo::InterfaceEndpointClient::HandleIncomingMessage C:\b\s\w\ir\cache\builder\src\mojo\public\cpp\bindings\lib\interface_endpoint_client.cc:701
    #13 0x7ffed8e74406 in IPC::`anonymous namespace'::ChannelAssociatedGroupController::AcceptOnEndpointThread C:\b\s\w\ir\cache\builder\src\ipc\ipc_mojo_bootstrap.cc:1069
    #14 0x7ffed8e6b241 in base::internal::Invoker<base::internal::BindState<void (IPC::(anonymous namespace)::ChannelAssociatedGroupController::*)(mojo::Message),scoped_refptr<IPC::(anonymous namespace)::ChannelAssociatedGroupController>,mojo::Message>,void ()>::RunOnce C:\b\s\w\ir\cache\builder\src\base\functional\bind_internal.h:976
    #15 0x7ffed82d1aa6 in base::TaskAnnotator::RunTaskImpl C:\b\s\w\ir\cache\builder\src\base\task\common\task_annotator.cc:186
    #16 0x7ffedb8f3f82 in base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::DoWorkImpl C:\b\s\w\ir\cache\builder\src\base\task\sequence_manager\thread_controller_with_message_pump_impl.cc:486
    #17 0x7ffedb8f2cff in base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::DoWork C:\b\s\w\ir\cache\builder\src\base\task\sequence_manager\thread_controller_with_message_pump_impl.cc:351
    #18 0x7ffed820ef40 in base::MessagePumpForUI::DoRunLoop C:\b\s\w\ir\cache\builder\src\base\message_loop\message_pump_win.cc:211
    #19 0x7ffed820c9c6 in base::MessagePumpWin::Run C:\b\s\w\ir\cache\builder\src\base\message_loop\message_pump_win.cc:77
    #20 0x7ffedb8f666f in base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::Run C:\b\s\w\ir\cache\builder\src\base\task\sequence_manager\thread_controller_with_message_pump_impl.cc:651
    #21 0x7ffed833c2d7 in base::RunLoop::Run C:\b\s\w\ir\cache\builder\src\base\run_loop.cc:134
    #22 0x7ffed228a48b in content::BrowserMainLoop::RunMainMessageLoop C:\b\s\w\ir\cache\builder\src\content\browser\browser_main_loop.cc:1067
    #23 0x7ffed2291697 in content::BrowserMainRunnerImpl::Run C:\b\s\w\ir\cache\builder\src\content\browser\browser_main_runner_impl.cc:158
    #24 0x7ffed2282102 in content::BrowserMain C:\b\s\w\ir\cache\builder\src\content\browser\browser_main.cc:34
    #25 0x7ffed6a39785 in content::RunBrowserProcessMain C:\b\s\w\ir\cache\builder\src\content\app\content_main_runner_impl.cc:707
    #26 0x7ffed6a3d841 in content::ContentMainRunnerImpl::RunBrowser C:\b\s\w\ir\cache\builder\src\content\app\content_main_runner_impl.cc:1284
    #27 0x7ffed6a3cf8b in content::ContentMainRunnerImpl::Run C:\b\s\w\ir\cache\builder\src\content\app\content_main_runner_impl.cc:1138

SUMMARY: AddressSanitizer: heap-use-after-free C:\b\s\w\ir\cache\builder\src\buildtools\third_party\libc++\trunk\include\__tree:866 in std::__Cr::__tree_iterator<std::__Cr::__value_type<void *,perfetto::base::UnixTaskRunner::WatchTask>,std::__Cr::__tree_node<std::__Cr::__value_type<void *,perfetto::base::UnixTaskRunner::WatchTask>,void *> *,long long>::operator++
Shadow bytes around the buggy address:
  0x1173e0150a00: f7 fa fd fd fd fd fd fd f7 fa 00 00 00 00 00 fa
  0x1173e0150a80: f7 fa fd fd fd fd fd fd f7 fa fd fd fd fd fd fa
  0x1173e0150b00: f7 fa fd fd fd fd fd fa f7 fa fd fd fd fd fd fa
  0x1173e0150b80: f7 fa fd fd fd fd fd fa f7 fa fd fd fd fd fd fa
  0x1173e0150c00: f7 fa fd fd fd fd fd fa f7 fa fd fd fd fd fd fa
=>0x1173e0150c80: f7 fa fd[fd]fd fd fd fd f7 fa fd fd fd fd fd fa
  0x1173e0150d00: f7 fa fd fd fd fd fd fa f7 fa fd fd fd fd fd fd
  0x1173e0150d80: f7 fa 00 00 00 00 00 00 f7 fa fd fd fd fd fd fd
  0x1173e0150e00: f7 fa fd fd fd fd fd fd f7 fa fd fd fd fd fd fd
  0x1173e0150e80: f7 fa fd fd fd fd fd fd f7 fa fd fd fd fd fd fd
  0x1173e0150f00: f7 fa fd fd fd fd fd fd f7 fa fd fd fd fd fd fd
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb

==14048==ADDITIONAL INFO

==14048==Note: Please include this section with the ASan report.
Task trace:
    #0 0x7ffed6a3f00f in content::`anonymous namespace'::BrowserConsoleControlHandler C:\b\s\w\ir\cache\builder\src\content\app\content_main_runner_impl.cc:496


MiraclePtr Status: NOT PROTECTED
No raw_ptr<T> access to this region was detected prior to this crash.
This crash is still exploitable with MiraclePtr.
Refer to https://chromium.googlesource.com/chromium/src/+/main/base/memory/raw_ptr.md for details.

==14048==END OF ADDITIONAL INFO
==14048==ABORTING